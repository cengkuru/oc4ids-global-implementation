<!-- app.component.html -->
<div class="flex flex-col h-screen bg-primary text-accent">
  <!-- Header -->
  <header class="bg-primary shadow-apple-md p-4 z-50">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <img src="assets/logo.png" alt="Logo" class="h-10 w-auto">
        <h1 class="text-xl font-bold leading-tight">Global OC4IDS Implementation Tracker</h1>
      </div>
      <div class="text-right text-sm">
        <p>Last Updated: {{ lastUpdated | date:'mediumDate' }}</p>
        <p>Total Countries: {{ stories.length }}</p>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow relative overflow-hidden">
    <!-- Map View -->
    <div id="map" class="w-full h-full"></div>

    <!-- Overlay Controls -->
    <div class="absolute top-4 left-4 z-[1000] space-y-4">
      <!-- Implementation Metrics Toggle -->
      <button (click)="toggleMetrics()" class="btn btn-primary flex items-center">
        <i class="bi bi-bar-chart-fill mr-2"></i> Implementation Metrics
      </button>

      <!-- Challenges Toggle -->
      <button (click)="toggleChallenges()" class="btn btn-primary flex items-center">
        <i class="bi bi-exclamation-triangle-fill mr-2"></i> Common Challenges
      </button>
    </div>

    <!-- Implementation Metrics Panel -->
    <div *ngIf="showMetrics" [@slideInOut] class="absolute top-20 left-4 bg-primary p-4 rounded-apple shadow-apple-md z-[1000] max-w-md">
      <h3 class="font-bold mb-4 text-lg">OC4IDS Implementation</h3>
      <div class="space-y-4">
        <div>
          <p class="mb-2">Fully Implemented</p>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div class="bg-accent6 h-2.5 rounded-full" [style.width.%]="implementationPercentage"></div>
          </div>
          <p class="text-right text-sm mt-1">{{ implementationPercentage | number:'1.0-0' }}%</p>
        </div>
        <div *ngFor="let status of statusColorsArray">
          <p class="mb-2">{{ status.name }}</p>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div [ngClass]="{'bg-accent6': status.name === 'Active', 'bg-secondary': status.name === 'Inactive', 'bg-accent1': status.name === 'In Development', 'bg-accent4': status.name === 'Other'}" class="h-2.5 rounded-full" [style.width.%]="implementationProgress[status.name] || 0"></div>
          </div>
          <p class="text-right text-sm mt-1">{{ (implementationProgress[status.name] || 0) | number:'1.0-0' }}%</p>
        </div>
      </div>
    </div>

    <!-- Common Challenges Panel -->
    <div *ngIf="showChallenges" [@slideInOut] class="absolute top-20 left-4 bg-primary p-4 rounded-apple shadow-apple-md z-[1000] max-w-md">
      <h3 class="font-bold mb-4 text-lg">Common Implementation Challenges</h3>
      <ul class="space-y-2">
        <li *ngFor="let challenge of commonChallenges" class="flex items-start">
          <i class="bi bi-dot text-accent6 mr-2 text-xl"></i>
          <span class="text-sm">{{ challenge }}</span>
        </li>
      </ul>
    </div>

    <!-- Map Legend -->
    <div class="absolute bottom-4 right-4 bg-primary p-3 rounded-apple shadow-apple-md z-[1000]">
      <h4 class="font-bold mb-2 text-sm flex items-center">
        <i class="bi bi-map mr-2"></i>Map Legend
      </h4>
      <div class="space-y-1">
        <div *ngFor="let status of statusColorsArray"
             class="flex items-center cursor-pointer hover:bg-primary-200 p-1 rounded-apple transition-all duration-250 ease-apple-out"
             (click)="toggleFilter(status.name)">
          <i class="bi bi-circle-fill mr-2 text-xs" [style.color]="status.color"></i>
          <span class="text-xs">{{ status.name }}</span>
          <i *ngIf="activeFilters.includes(status.name)" class="bi bi-check-lg ml-auto text-accent6"></i>
        </div>
      </div>
      <button *ngIf="activeFilters.length > 0"
              (click)="clearFilters()"
              class="mt-2 text-xs text-secondary hover:text-accent6 transition-colors duration-250 ease-apple-out flex items-center">
        <i class="bi bi-x-circle mr-1"></i>Clear Filters
      </button>
    </div>

    <!-- Selected Story Details -->
    <div *ngIf="selectedStory" [@slideInOut] class="absolute bottom-0 left-0 right-0 bg-primary p-6 shadow-apple-lg rounded-t-apple-lg z-30" style="max-height: 60vh; overflow-y-auto;">
      <div class="flex justify-between items-start mb-4">
        <h2 class="text-2xl font-bold flex items-center text-accent">
          <i class="bi bi-pin-map-fill mr-3 text-secondary"></i>
          {{ selectedStory.properties.country }}
        </h2>
        <button (click)="closeSelectedStory()" class="text-accent hover:text-secondary transition-colors duration-250 ease-apple-out">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-4">
          <div class="flex items-center">
            <i class="bi bi-globe2 mr-3 text-accent4"></i>
            <div>
              <p class="text-sm text-accent4">Region</p>
              <p class="font-semibold">{{ selectedStory.properties.region }}</p>
            </div>
          </div>

          <div class="flex items-center">
            <i class="bi bi-circle-fill mr-3 text-xs" [style.color]="getColorForStatus(selectedStory.properties.status)"></i>
            <div>
              <p class="text-sm text-accent4">Status</p>
              <p class="font-semibold">{{ selectedStory.properties.status }}</p>
            </div>
          </div>

          <div class="flex items-center">
            <i class="bi bi-bar-chart-fill mr-3 text-accent5"></i>
            <div>
              <p class="text-sm text-accent4">Projects Disclosed</p>
              <p class="font-semibold">{{ selectedStory.properties.projectsDisclosed }}</p>
            </div>
          </div>

          <div class="flex items-center">
            <i class="bi bi-file-earmark-text mr-3 text-accent6"></i>
            <div>
              <p class="text-sm text-accent4">Disclosure Mandate</p>
              <p class="font-semibold">{{ selectedStory.properties.disclosureMandate || 'N/A' }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="selectedStory.properties.achievements.length > 0">
          <h3 class="font-bold text-lg mb-3 flex items-center text-accent">
            <i class="bi bi-trophy-fill mr-2 text-accent1"></i>
            Achievements
          </h3>
          <ul class="space-y-2">
            <li *ngFor="let achievement of selectedStory.properties.achievements" class="flex items-start">
              <i class="bi bi-check-circle-fill mr-2 mt-1 text-accent6"></i>
              <span class="text-sm">{{ achievement }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-primary p-4 text-center text-sm text-accent4">
    <p>Â© {{ lastUpdated | date:'yyyy' }} Global OC4IDS Implementation Tracker. All rights reserved.</p>
  </footer>
</div>
