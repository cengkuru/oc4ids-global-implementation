<div class="flex flex-col h-screen bg-primary text-accent">
  <!-- Header -->
  <header class="bg-primary-400 text-accent p-4 shadow-apple-md relative z-50">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="/" class="mr-4">
          <img src="assets/logo.png" alt="Logo" class="h-10 w-auto">
        </a>
        <h1 class="text-xl font-bold leading-tight">Global OC4IDS Implementation Tracker</h1>
      </div>
      <div class="text-right">
        <p class="text-sm">Last Updated: {{ lastUpdated | date:'mediumDate' }}</p>
        <p class="text-sm">Total Countries: {{ stories.length }}</p>
      </div>
    </div>
  </header>
  <!-- Main Content -->
  <main class="flex-grow relative overflow-hidden">
    <!-- Map View -->
    <div id="map" class="w-full h-full"></div>

    <!-- Implementation Metrics -->
    <div class="absolute top-4 left-4 bg-primary p-4 rounded-apple shadow-apple-md z-[1000] max-w-md">
      <h3 class="font-bold mb-2">OC4IDS Implementation</h3>
      <p>Fully Implemented: {{ implementationPercentage | number:'1.0-0' }}%</p>
      <div class="mt-4">
        <h4 class="font-semibold mb-2">Implementation Progress</h4>
        <div *ngFor="let status of statusColorsArray" class="flex items-center mb-2">
          <div class="w-24 text-sm">{{ status.name }}:</div>
          <div class="flex-grow bg-gray-200 rounded-full h-2.5 mr-2">
            <div class="bg-accent6 h-2.5 rounded-full" [style.width.%]="implementationProgress[status.name] || 0"></div>
          </div>
          <div class="text-sm w-12 text-right">{{ (implementationProgress[status.name] || 0) | number:'1.0-0' }}%</div>
        </div>
      </div>
    </div>
    <!-- Common Challenges -->
    <div class="absolute top-4 right-4 bg-primary p-4 rounded-apple shadow-apple-md z-[1000] max-w-md">
      <h3 class="font-bold mb-2">Common Implementation Challenges</h3>
      <ul class="list-disc pl-5">
        <li *ngFor="let challenge of commonChallenges" class="text-sm mb-1">{{ challenge }}</li>
      </ul>
    </div>

    <!-- Color Key (Always visible) -->
    <div class="absolute bottom-4 right-4 bg-primary p-3 rounded-apple shadow-apple-md z-[1000]">
      <h4 class="font-bold mb-2 text-sm flex items-center">
        <i class="bi bi-info-circle mr-2"></i>Map Key
      </h4>
      <div *ngFor="let status of statusColorsArray" class="flex items-center mb-1 cursor-pointer hover:bg-primary-200 p-1 rounded-apple transition-all duration-250 ease-apple-out" (click)="toggleFilter(status.name)">
        <i class="bi bi-circle-fill mr-2 text-xs" [style.color]="status.color"></i>
        <span class="text-xs">{{ status.name }}</span>
        <i *ngIf="activeFilters.includes(status.name)" class="bi bi-check-lg ml-2 text-accent6"></i>
      </div>
      <button *ngIf="activeFilters.length > 0" (click)="clearFilters()" class="mt-2 text-xs text-secondary hover:text-secondary-300 transition-colors duration-250 ease-apple-out">
        <i class="bi bi-x-circle mr-1"></i>Clear Filters
      </button>
    </div>

    <!-- Selected Story Details -->
    <div *ngIf="selectedStory" class="absolute bottom-0 left-0 right-0 bg-primary p-6 shadow-apple-lg rounded-t-apple-lg z-30" style="max-height: 60vh; overflow-y-auto;">
      <div class="flex justify-between items-start mb-4">
        <h2 class="text-2xl font-bold flex items-center text-accent">
          <i class="bi bi-pin-map-fill mr-3 text-secondary"></i>
          {{ selectedStory.properties.country }}
        </h2>
        <button (click)="closeSelectedStory()" class="text-accent hover:text-secondary transition-colors duration-250 ease-apple-out">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="space-y-4">
        <div class="flex items-center">
          <i class="bi bi-globe2 mr-3 text-accent-100"></i>
          <div>
            <p class="text-sm text-accent-100">Region</p>
            <p class="font-semibold">{{ selectedStory.properties.region }}</p>
          </div>
        </div>

        <div class="flex items-center">
          <i class="bi bi-circle-fill mr-3 text-xs" [style.color]="getColorForStatus(selectedStory.properties.status)"></i>
          <div>
            <p class="text-sm text-accent-100">Status</p>
            <p class="font-semibold">{{ selectedStory.properties.status }}</p>
          </div>
        </div>

        <div class="flex items-center">
          <i class="bi bi-bar-chart-fill mr-3 text-accent-100"></i>
          <div>
            <p class="text-sm text-accent-100">Projects Disclosed</p>
            <p class="font-semibold">{{ selectedStory.properties.projectsDisclosed }}</p>
          </div>
        </div>

        <div class="flex items-center">
          <i class="bi bi-file-earmark-text mr-3 text-accent-100"></i>
          <div>
            <p class="text-sm text-accent-100">Disclosure Mandate</p>
            <p class="font-semibold">{{ selectedStory.properties.disclosureMandate || 'N/A' }}</p>
          </div>
        </div>

        <div *ngIf="selectedStory.properties.achievements.length > 0" class="mt-6">
          <h3 class="font-bold text-lg mb-3 flex items-center text-accent">
            <i class="bi bi-trophy-fill mr-2 text-accent5"></i>
            Achievements
          </h3>
          <ul class="space-y-2">
            <li *ngFor="let achievement of selectedStory.properties.achievements" class="flex items-start">
              <i class="bi bi-check-circle-fill mr-2 mt-1 text-accent6"></i>
              <span class="text-sm">{{ achievement }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-primary-400 p-4 text-center text-sm text-accent-100">
    <p>Â© {{ lastUpdated | date:'yyyy' }} Global OC4IDS Implementation Tracker. All rights reserved.</p>
  </footer>
</div>
